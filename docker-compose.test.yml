# Docker Compose for running Dream Lab tests
version: '3.8'

services:
  test:
    build:
      context: .
      dockerfile: Dockerfile.test
    image: dreamlab-test:latest
    container_name: dreamlab-test
    env_file:
      - env.dev
      - env.cuda
    volumes:
      - ./server:/app/server:ro,Z
      - ./backends:/app/backends:ro,Z
      - ./utils:/app/utils:ro,Z
      - ./persistence:/app/persistence:ro,Z
      - ./tests:/app/tests:ro,Z
      - ./invokers:/app/invokers:ro,Z
      - ${MODELS_HOST_PATH:-./model}:/models:ro,Z
      - ${FS_HOST_PATH:-./store}:/store:rw,Z
      - ${WORKFLOW_HOST_PATH:-./workflows}:/workflows:ro,Z
      - ./conf-test:/app/conf:rw,Z
      - ./htmlcov:/app/htmlcov
    command: pytest tests/ -v --cov=backends --cov=server --cov-report=html --cov-report=term-missing

  test-unit:
    extends: test
    container_name: dreamlab-test-not-ws
    command: pytest tests/ -v -m "not ws"

  test-ws:
    extends: test
    container_name: dreamlab-test-ws
    command: pytest tests/ -m ws -v

  test-fast:
    extends: test
    container_name: dreamlab-test-fast
    command: pytest tests/ -v -m "not slow"

  test-watch:
    extends: test
    container_name: dreamlab-test-watch
    command: ptw tests/ -- -v
